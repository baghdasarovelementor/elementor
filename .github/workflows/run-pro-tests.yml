name: Run Pro Tests

on:
  push:
  pull_request:
    types: [ labeled ]
  repository_dispatch:
    types: [ remote-tests ]

env:
  RUN_TESTS: ${{ github.event.label.name == 'run-pro-tests' }}

jobs:
  init-core-checks:
    name: Init Core Checks
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      - name: Get Github-App token
        if: always()
        id: get_token
        uses: getsentry/action-github-app-token@38e217dc0fddb8008773820fae0875f439a614de # v1.0.4
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}
      - name: Init PHPUnit Check
        uses: LouisBrunner/checks-action@2a1af428dc34afcf0f8eda00ff832f69678fef76 # v1.1.2
        if: always()
        with:
          name: Elementor Tests / PHPUnit
          repo: elementor/elementor
          sha: ${{ github.event.client_payload.sha }}
          token: ${{ steps.get_token.outputs.token }}
          status: in_progress
      - name: Init Screenshotter Check
        uses: LouisBrunner/checks-action@2a1af428dc34afcf0f8eda00ff832f69678fef76 # v1.1.2
        if: always()
        with:
          name: Elementor Tests / Screenshotter
          repo: elementor/elementor
          sha: ${{ github.event.client_payload.sha }}
          token: ${{ steps.get_token.outputs.token }}
          status: in_progress

  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      - name: Cache node modules
        uses: actions/cache@v2
        env:
          cache-name: cache-node-modules
        with:
          path: ~/.npm
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-
      - name: Clone & Build Pro
        run: |
          cd ~/
          git clone 'https://github.com/${{ github.event.client_payload.repository }}' elementor-pro
          cd elementor-pro
          git checkout ${{ github.event.client_payload.sha }}
          npm ci && npx grunt
      - name: Save Pro Build to Cache
        uses: actions/cache@v2
        env:
          key: ${{ github.sha }}-${{ github.event.client_payload.sha }}-pro
        with:
          path: ~/elementor-pro/*
          key: ${{ env.key }}
          restore-keys: ${{ env.key }}
      - name: Checkout Core source code
        uses: actions/checkout@v2
      - name: Build Core
        run: |
          ln -s ~/elementor ../elementor-pro
          npm i && grunt
      - name: Save Core Build to Cache
        uses: actions/cache@v2
        env:
          key: build-${{ github.sha }}
        with:
          path: ./*
          key: ${{ env.key }}
          restore-keys: ${{ env.key }}

  phpunit:
    name: PHPUnit
    needs: [ build ]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      - name: Startup MySQL service
        run: sudo /etc/init.d/mysql start
      - name: Checkout source code
        uses: actions/checkout@v2
      - name: Install Dependencies
        run: |
          bash bin/install-wp-tests.sh wordpress_test root root localhost latest
          wget --quiet -O /tmp/phpunit-7 https://phar.phpunit.de/phpunit-7.phar
      - name: Restore Core Build From Cache
        uses: actions/cache@v2
        env:
          key: ${{ github.sha }}-${{ github.event.client_payload.sha }}-core
        with:
          path: ~/elementor-pro/*
          key: ${{ env.key }}
      - name: Replace Default Pro
        run: |
          rm -rf /tmp/wordpress/wp-content/plugins/elementor-pro
          ln -s ~/elementor-pro /tmp/wordpress/wp-content/plugins/elementor-pro
      - name: PHP7.4
        run: php7.4 /tmp/phpunit-7
      - name: PHP7.4 - Multisite
        run: WP_MULTISITE=1 php7.4 /tmp/phpunit-7
      - name: Get Github-App token
        if: always()
        id: get_token
        uses: getsentry/action-github-app-token@v1
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}
      - name: Set Pro check-run status
        uses: LouisBrunner/checks-action@2a1af428dc34afcf0f8eda00ff832f69678fef76 # v1.1.2
        if: always()
        with:
          name: Elementor Pro Tests / PHPUnit
          repo: elementor/elementor-pro
          sha: ${{ github.event.client_payload.sha }}
          token: ${{ steps.get_token.outputs.token }}
          status: completed
          conclusion: ${{ job.status }}
          details_url: ${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}
